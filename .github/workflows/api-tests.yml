name: API Tests

on:
  pull_request:
    paths:
      - 'api/**'
      - 'logos/**'
      - 'package.json'
  push:
    branches:
      - main
    paths:
      - 'api/**'
      - 'logos/**'
      - 'package.json'
  workflow_dispatch:

jobs:
  test-api:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Start local server for testing
        run: |
          # Install Vercel CLI for local testing
          npm install -g vercel@latest
          
          # Start local development server in background
          vercel dev --listen 3000 &
          
          # Wait for server to start
          sleep 10
          
          # Test if server is running
          curl -f http://localhost:3000/api/health || exit 1
          
      - name: Test API endpoints
        run: |
          echo "ðŸ§ª Testing API endpoints..."
          
          # Test health endpoint
          echo "Testing /api/health..."
          curl -f http://localhost:3000/api/health
          
          # Test logos listing
          echo "Testing /api/v1/logos..."
          curl -f http://localhost:3000/api/v1/logos
          
          # Test specific logo metadata
          echo "Testing /api/v1/logos/google..."
          curl -f http://localhost:3000/api/v1/logos/google
          
          # Test logo file serving
          echo "Testing logo file serving..."
          curl -f http://localhost:3000/api/v1/logos/google?file=google-standard.svg
          
          # Test PNG conversion
          echo "Testing PNG conversion..."
          curl -f http://localhost:3000/api/v1/logos/google?file=google-standard.png&size=64
          
          # Test color customization
          echo "Testing color customization..."
          curl -f "http://localhost:3000/api/v1/logos/google?file=google-standard.svg&color=%23ff0000"
          
          echo "âœ… All API tests passed!"
          
      - name: Test logo validation API
        run: |
          echo "ðŸ” Testing logo validation..."
          
          # Test validation for existing logo
          node tools/logo-validator.js google
          
          # Test validation for all logos
          npm run validate:all
          
          echo "âœ… Logo validation tests passed!"
          
      - name: Performance test
        run: |
          echo "âš¡ Running performance tests..."
          
          # Test response times for key endpoints
          time curl -s http://localhost:3000/api/v1/logos > /dev/null
          time curl -s http://localhost:3000/api/v1/logos/google > /dev/null
          time curl -s http://localhost:3000/api/v1/logos/google?file=google-standard.svg > /dev/null
          
          echo "âœ… Performance tests completed!"
          
      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸ§ª API Test Results
            
            âœ… All API tests passed successfully!
            
            **Tested endpoints:**
            - \`/api/health\` - Health check
            - \`/api/v1/logos\` - Logo listing
            - \`/api/v1/logos/{id}\` - Logo metadata
            - \`/api/v1/logos/{id}?file={name}\` - Logo file serving
            - PNG conversion with size parameter
            - Color customization
            - Logo validation
            
            **Performance:** All endpoints responded within acceptable time limits.
            
            ---
            *This comment was automatically generated by the API Tests workflow.*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            }); 