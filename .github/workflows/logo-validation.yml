name: Logo Validation

on:
  pull_request:
    paths:
      - 'logos/**'
  push:
    branches:
      - main
    paths:
      - 'logos/**'

jobs:
  validate-logos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Validate all logos
        run: npm run validate:all
        
      - name: Check for new logos in PR
        if: github.event_name == 'pull_request'
        run: |
          # Get list of changed logo directories
          CHANGED_LOGOS=$(git diff --name-only origin/main...HEAD | grep '^logos/' | cut -d'/' -f2 | sort -u | grep -v '^$')
          
          if [ -n "$CHANGED_LOGOS" ]; then
            echo "ðŸ” Validating changed logos:"
            for logo in $CHANGED_LOGOS; do
              echo "  - $logo"
              if [ -d "logos/$logo" ]; then
                npm run logo:validate -- "$logo"
              fi
            done
          else
            echo "â„¹ï¸ No logo changes detected"
          fi
          
      - name: Check SVG optimization
        run: |
          echo "ðŸ” Checking SVG optimization..."
          find logos -name "*-standard.svg" -exec npm run logo:optimize -- {} \;
          
          # Check if any files were modified (indicating they weren't optimized)
          if [ -n "$(git status --porcelain)" ]; then
            echo "âŒ Some SVG files are not optimized. Please run 'npm run logo:optimize' on the following files:"
            git status --porcelain
            exit 1
          else
            echo "âœ… All SVG files are properly optimized"
          fi
          
      - name: Generate logo report
        run: |
          echo "ðŸ“Š Logo Collection Report" > logo-report.md
          echo "=========================" >> logo-report.md
          echo "" >> logo-report.md
          echo "**Total logos:** $(ls logos | grep -v '.DS_Store' | wc -l)" >> logo-report.md
          echo "" >> logo-report.md
          echo "**Logo list:**" >> logo-report.md
          for logo in $(ls logos | grep -v '.DS_Store' | sort); do
            echo "- $logo" >> logo-report.md
          done
          
          cat logo-report.md
          
      - name: Comment PR with validation results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read the logo report if it exists
            let report = '';
            try {
              report = fs.readFileSync('logo-report.md', 'utf8');
            } catch (e) {
              report = 'ðŸ“Š Logo validation completed successfully!';
            }
            
            const comment = `## ðŸŽ¨ Logo Validation Results
            
            âœ… All logo validation checks passed!
            
            ${report}
            
            ---
            *This comment was automatically generated by the Logo Validation workflow.*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            }); 